{% extends "base.html" %}
{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª ØµÙ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†{% endblock %}

{% block content %}
<h2>Ù…Ø¯ÛŒØ±ÛŒØª ØµÙ Ø±Ø§Ù†Ù†Ø¯Ú¯Ø§Ù†</h2>

<form id="addForm" method="post" action="{% url 'add_driver_to_queue' %}" style="margin-bottom:20px; position:relative;">
    {% csrf_token %}
    <input type="text" id="driverSearch" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡..." autocomplete="off">
    <input type="hidden" name="driver_id" id="driverId">
    <select name="zone">
        <option value="city">Ø´Ù‡Ø±</option>
        <option value="village">Ø±ÙˆØ³ØªØ§</option>
    </select>
    <button type="submit" class="button" style="margin-top:10px;width:100%;">Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù‡ ØµÙ</button>

    <!-- Ù…Ø­Ù„ Ù†Ù…Ø§ÛŒØ´ Ø®Ø·Ø§ -->
    <div id="errorBoxDriver" style="color:red; margin-top:10px;"></div>

    <!-- Ø³Ø§Ø¬Ø³Øª Ø±Ø§Ù†Ù†Ø¯Ù‡ -->
    <ul id="suggestions"></ul>
</form>

<hr>

<h3>ØµÙ Ø´Ù‡Ø±</h3>
<table>
    <tr><th>#</th><th>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</th><th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th><th>Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
    {% for d in city_queue %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ d.driver.name }}</td>
        <td>{{ d.driver.phone }}</td>
        <td>{{ d.joined_at|date:"Y-m-d H:i" }}</td>
        <td><a href="{% url 'remove_driver' d.id %}" class="btn btn-danger btn-sm">Ø­Ø°Ù</a></td>
    </tr>
    {% empty %}
    <tr><td colspan="5">ØµÙ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</td></tr>
    {% endfor %}
</table>

<h3>ØµÙ Ø±ÙˆØ³ØªØ§</h3>
<table>
    <tr><th>#</th><th>Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡</th><th>Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³</th><th>Ø²Ù…Ø§Ù† ÙˆØ±ÙˆØ¯</th><th>Ø¹Ù…Ù„ÛŒØ§Øª</th></tr>
    {% for d in village_queue %}
    <tr>
        <td>{{ forloop.counter }}</td>
        <td>{{ d.driver.name }}</td>
        <td>{{ d.driver.phone }}</td>
        <td>{{ d.joined_at|date:"Y-m-d H:i" }}</td>
        <td><a href="{% url 'remove_driver' d.id %}" class="btn btn-danger btn-sm">Ø­Ø°Ù</a></td>
    </tr>
    {% empty %}
    <tr><td colspan="5">ØµÙ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</td></tr>
    {% endfor %}
</table>

<hr>

<h3>ØªØ³Øª Ø¯Ø³ØªØ±Ø³ÛŒ Ø±Ø§Ù†Ù†Ø¯Ù‡</h3>
<form id="accessForm" action="{% url 'check_driver_access' %}" method="post" style="margin-bottom:10px;">
    {% csrf_token %}
    <input type="text" name="driver_name" placeholder="Ù†Ø§Ù… Ø±Ø§Ù†Ù†Ø¯Ù‡...">
    <hr>
    <button type="submit" class="button">Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ±Ù‡Ø§</button>
</form>

<!-- Ø¬Ø¯ÙˆÙ„ Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ±Ù‡Ø§ -->
<table id="tripTable">
    <thead>
        <tr><th>Ù…Ø³Ø§ÙØ±</th><th>Ù…Ø¨Ø¯Ø£</th><th>Ù…Ù‚ØµØ¯</th><th>Ù†ÙˆØ¹ Ø³ÙØ±</th></tr>
    </thead>
    <tbody id="tripResults">
        <tr><td colspan="4">ÙØ¹Ù„Ø§Ù‹ Ø¯Ø§Ø¯Ù‡â€ŒØ§ÛŒ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯</td></tr>
    </tbody>
</table>

<script>
const searchBox = document.getElementById("driverSearch");
const driverIdInput = document.getElementById("driverId");
const suggestions = document.getElementById("suggestions");
const errorBoxDriver = document.getElementById("errorBoxDriver");

searchBox.addEventListener("input", async () => {
    const q = searchBox.value.trim();
    if (!q) { suggestions.innerHTML = ""; return; }
    const res = await fetch(`/ride/search-drivers/?q=${q}`);
    const data = await res.json();
    suggestions.innerHTML = "";
    data.forEach(item => {
        const li = document.createElement("li");
        li.textContent = item.name;
        li.onclick = () => {
            driverIdInput.value = item.id;
            searchBox.value = item.name;
            suggestions.innerHTML = "";
        };
        suggestions.appendChild(li);
    });
});

document.getElementById("addForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    errorBoxDriver.textContent = "";
    const formData = new FormData(e.target);
    const res = await fetch(e.target.action, { method: "POST", body: formData });

    // ğŸ‘‡ Ù‡Ù†Ø¯Ù„ÛŒÙ†Ú¯ Ø§Ø±ÙˆØ± Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯ (Ø§Ú¯Ø± JSON Ø¨ÙˆØ¯)
    const contentType = res.headers.get("Content-Type");
    if (contentType && contentType.includes("application/json")) {
        const data = await res.json();
        if (data.error) {
            errorBoxDriver.textContent = data.error;
            return;
        }
    }

    // Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØªØŒ ØµÙØ­Ù‡ Ø±ÙØ±Ø´ Ø´ÙˆØ¯
    window.location.reload();
});

document.getElementById("accessForm").addEventListener("submit", async (e) => {
    e.preventDefault();
    const formData = new FormData(e.target);
    const res = await fetch(e.target.action, { method: "POST", body: formData });
    const data = await res.json();
    const tbody = document.getElementById("tripResults");
    tbody.innerHTML = "";
    if (data.error) {
        tbody.innerHTML = `<tr><td colspan="4" style="color:red;">${data.error}</td></tr>`;
    } else if (!data.trips.length) {
        tbody.innerHTML = `<tr><td colspan="4">Ù‡ÛŒÚ† Ø³ÙØ±ÛŒ ÛŒØ§ÙØª Ù†Ø´Ø¯</td></tr>`;
    } else {
        data.trips.forEach(t => {
            tbody.innerHTML += `<tr><td>${t.passenger}</td><td>${t.origin}</td><td>${t.destination}</td><td>${t.type}</td></tr>`;
        });
    }
});
</script>
{% endblock %}
