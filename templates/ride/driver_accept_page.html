{% extends 'base.html' %}
{% load static %}

{% block title %}پذیرش درخواست‌ها توسط راننده{% endblock %}

{% block content %}

<h2>پذیرش درخواست‌ها توسط راننده</h2>

<!-- بخش بررسی راننده و صف -->
<div class="form-group">
    <label for="driverName">نام راننده:</label>
    <input type="text" id="driverName" placeholder="مثلاً علی رضایی">
    <button class="button" id="checkAccessBtn">بررسی دسترسی</button>
    <div id="accessError" class="error-message"></div>
</div>

<!-- بخش نمایش درخواست‌های فعال -->
<div id="requestsSection" style="display:none;">
    <h3>درخواست‌های فعال قابل پذیرش</h3>

    <table border="1" style="width:100%; border-collapse:collapse; text-align:center;">
        <thead>
            <tr>
                <th>انتخاب</th>
                <th>مسافر</th>
                <th>مبدأ</th>
                <th>مقصد</th>
                <th>نوع درخواست</th>
            </tr>
        </thead>
        <tbody id="tripBody"></tbody>
    </table>

    <button class="button" id="acceptBtn" style="margin-top:15px;">✅ قبول درخواست‌ها</button>
    <div id="acceptResult" class="success-box" style="margin-top:10px;"></div>
</div>

<!-- بخش نمایش سفرهای پذیرفته‌شده -->
<h3 style="margin-top:40px;">سفرهای پذیرفته‌شده</h3>

{% for trip in movements %}
<table class="table table-bordered" style="margin-bottom:30px;">
    <thead>
        <tr>
            <th>زمان ثبت</th>
            <th>منطقه</th>
            <th>نوع درخواست</th>
            <th>مسافر</th>
            <th>راننده</th>
            <th>وضعیت سفر</th>
            <th>عملیات</th>
        </tr>
    </thead>
    <tbody>
        <tr>
            <td>{{ trip.created_at }}</td>
            <td>{{ trip.zone }}</td>
            <td>{{ trip.request_type }}</td>
            <td>{{ trip.passenger.username }}</td>
            <td>{{ trip.driver.username }}</td>
            <td>
                {% if trip.is_finished %}
                    <span style="color:green;">✅ پایان‌یافته</span>
                {% else %}
                    <span style="color:orange;">در حال انجام</span>
                {% endif %}
            </td>
            <td>
                {% if not trip.is_finished %}
                    <button class="btn btn-success btn-sm end-trip" data-id="{{ trip.id }}">پایان سفر</button>
                {% endif %}
                <button class="btn btn-danger btn-sm delete-trip" data-id="{{ trip.id }}">حذف</button>
            </td>
        </tr>
    </tbody>
</table>
{% empty %}
<p style="color:gray;">هیچ سفری پذیرفته نشده است.</p>
{% endfor %}


<script>
// عناصر DOM
const driverInput = document.getElementById('driverName');
const checkBtn = document.getElementById('checkAccessBtn');
const tripBody = document.getElementById('tripBody');
const requestsSection = document.getElementById('requestsSection');
const accessError = document.getElementById('accessError');
const acceptBtn = document.getElementById('acceptBtn');
const acceptResult = document.getElementById('acceptResult');
let driverId = null;

// بررسی دسترسی راننده و دریافت داده‌های سفر
checkBtn.addEventListener('click', async () => {
    accessError.textContent = '';
    tripBody.innerHTML = '';
    requestsSection.style.display = 'none';
    acceptResult.textContent = '';
    driverId = null;

    const driverName = driverInput.value.trim();
    if (!driverName) {
        accessError.textContent = 'نام راننده را وارد کنید.';
        return;
    }

    const res = await fetch("{% url 'check_driver_access' %}", {
        method: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            "X-CSRFToken": "{{ csrf_token }}"
        },
        body: new URLSearchParams({ driver_name: driverName })
    });

    const data = await res.json();

    if (data.error) {
        accessError.textContent = data.error;
        return;
    }

    // نمایش درخواست‌ها
    requestsSection.style.display = "block";
    driverId = data.driver_id || null;

    data.trips.forEach(trip => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox" name="trip_ids" value="${trip.id}"></td>
            <td>${trip.passenger}</td>
            <td>${trip.origin}</td>
            <td>${trip.destination}</td>
            <td>${trip.type}</td>
        `;
        tripBody.appendChild(tr);
    });
});

// پذیرش درخواست‌ها
acceptBtn.addEventListener('click', async () => {
    const checked = [...document.querySelectorAll('input[name="trip_ids"]:checked')].map(x => x.value);

    if (checked.length === 0) {
        acceptResult.textContent = 'هیچ درخواستی انتخاب نشده است.';
        return;
    }
    if (!driverId) {
        acceptResult.textContent = 'شناسه راننده یافت نشد.';
        return;
    }

    const formData = new URLSearchParams();
    formData.append('driver_id', driverId);
    checked.forEach(id => formData.append('trip_ids', id));

    const res = await fetch("{% url 'accept_requests' %}", {
        method: "POST",
        body: formData
        // CSRFToken is not needed if you use @csrf_exempt
    });

    const data = await res.json();

    if (res.ok) {
        acceptResult.textContent = 'درخواست‌ها با موفقیت پذیرفته شدند. در حال بارگذاری مجدد...';
        
        // ✅ **اصلاح شد**: رفرش صفحه با حفظ شناسه راننده
        setTimeout(() => {
            window.location.href = `/ride/driver_accept_page/?driver_id=${driverId}`;
        }, 1500);

    } else {
        acceptResult.textContent = 'خطا در ثبت پذیرش: ' + (data.error || 'خطای نامشخص');
    }
});
// حذف سفر پذیرفته‌شده
document.querySelectorAll('.delete-trip').forEach(btn => {
    btn.addEventListener('click', async () => {
        const tripId = btn.getAttribute('data-id');
        const confirmed = confirm('آیا از حذف این سفر مطمئن هستید؟');
        if (!confirmed) return;

        const response = await fetch(`/ride/delete_trip/${tripId}/`, { method: 'POST' });
        if (response.ok) {
            btn.closest('table').remove();
            console.log(`Trip ${tripId} deleted`);
        } else {
            alert('خطا در حذف سفر.');
        }
    });
});

// پایان سفر
document.querySelectorAll('.end-trip').forEach(btn => {
    btn.addEventListener('click', async () => {
        const tripId = btn.dataset.id;
        const res = await fetch(`/ride/finish_trip/${tripId}/`, { method: 'POST' });
        const data = await res.json();

        if (data.success) {
            btn.closest('table').querySelector('td:nth-child(6)').innerHTML =
                '<span style="color:green;">✅ پایان‌یافته</span>';
            btn.remove();
            console.log(`Trip ${tripId} finished`);
        } else {
            alert(data.error || 'خطا در پایان سفر');
        }
    });
});
</script>

{% endblock %}

