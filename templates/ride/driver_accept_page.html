{% extends 'base.html' %}
{% load static %}

{% block title %}پذیرش درخواست‌ها و مدیریت سفر{% endblock %}

{% block content %}

<h2>پذیرش درخواست‌ها توسط راننده</h2>

<!-- بخش بررسی راننده و صف -->
<div class="form-group">
    <label for="driverName">نام راننده:</label>
    <input type="text" id="driverName" placeholder="مثلاً علی رضایی">
    <button class="button" id="checkAccessBtn">بررسی دسترسی</button>
    <div id="accessError" class="error-message"></div>
</div>

<!-- ✅ دکمه جدید برای نمایش تمام سفرهای فعال -->
<div class="form-group" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px;">
    <button class="button" id="showAllActiveTripsBtn">نمایش تمام سفرهای فعال</button>
</div>


<!-- بخش نمایش درخواست‌های فعال (برای پذیرش) -->
<div id="requestsSection" style="display:none;">
    <h3>درخواست‌های فعال قابل پذیرش</h3>
    <table border="1" style="width:100%; text-align:center;">
        <thead>
            <tr>
                <th>انتخاب</th>
                <th>مسافر</th>
                <th>مبدأ</th>
                <th>مقصد</th>
                <th>نوع درخواست</th>
            </tr>
        </thead>
        <tbody id="tripBody"></tbody>
    </table>
    <button class="button" id="acceptBtn" style="margin-top:15px;">✅ قبول درخواست‌ها</button>
    <div id="acceptResult" class="success-box"></div>
</div>


<!-- ✅ بخش جدید برای نمایش تمام سفرهای فعال (که با دکمه پر می‌شود) -->
<div id="allActiveTripsSection" style="display:none; margin-top:30px;">
    <h3>تمام سفرهای در حال انجام</h3>
    <table class="table table-bordered">
        <thead>
            <tr>
                <th>زمان ثبت</th>
                <th>منطقه</th>
                <th>نوع درخواست</th>
                <th>مسافر</th>
                <th>راننده</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="allActiveTripsBody"></tbody>
    </table>
</div>


<!-- بخش نمایش سفرهای پذیرفته‌شده (مربوط به یک راننده خاص، اگر از قبل لود شده باشد) -->
<h3 style="margin-top:40px;">سفرهای پذیرفته‌شده (مربوط به راننده جستجو شده)</h3>
{% for trip in movements %}
<table class="table table-bordered" data-trip-id="{{ trip.id }}">
    <tbody>
        <tr>
            <td>{{ trip.created_at }}</td>
            <td>{{ trip.zone }}</td>
            <td>{{ trip.request_type }}</td>
            <td>{{ trip.passenger.username }}</td>
            <td>{{ trip.driver.username }}</td>
            <td>
                {% if not trip.is_finished %}
                    <button class="btn btn-success btn-sm end-trip" data-id="{{ trip.id }}">پایان سفر</button>
                {% endif %}
                <button class="btn btn-danger btn-sm delete-trip" data-id="{{ trip.id }}">حذف</button>
            </td>
        </tr>
    </tbody>
</table>
{% empty %}
<p style="color:gray;">برای راننده مشخصی سفری یافت نشد.</p>
{% endfor %}


<script>
// === عناصر DOM ===
const driverInput = document.getElementById('driverName');
const checkBtn = document.getElementById('checkAccessBtn');
const tripBody = document.getElementById('tripBody');
const requestsSection = document.getElementById('requestsSection');
const accessError = document.getElementById('accessError');
const acceptBtn = document.getElementById('acceptBtn');
const acceptResult = document.getElementById('acceptResult');

// ✅ عناصر جدید
const showAllActiveTripsBtn = document.getElementById('showAllActiveTripsBtn');
const allActiveTripsSection = document.getElementById('allActiveTripsSection');
const allActiveTripsBody = document.getElementById('allActiveTripsBody');
let driverId = null;

// === رویدادها (Event Listeners) ===

// 1. بررسی دسترسی راننده (مثل قبل)
checkBtn.addEventListener('click', async () => { /* ... کد این بخش بدون تغییر باقی می‌ماند ... */ });
checkBtn.addEventListener('click', async () => {
    accessError.textContent = '';
    tripBody.innerHTML = '';
    requestsSection.style.display = 'none';
    acceptResult.textContent = '';
    driverId = null;

    const driverName = driverInput.value.trim();
    if (!driverName) {
        accessError.textContent = 'نام راننده را وارد کنید.';
        return;
    }

    const res = await fetch("{% url 'check_driver_access' %}", {
        method: "POST",
        headers: {"Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": "{{ csrf_token }}"},
        body: new URLSearchParams({ driver_name: driverName })
    });

    const data = await res.json();
    if (data.error) {
        accessError.textContent = data.error;
        return;
    }
    requestsSection.style.display = "block";
    driverId = data.driver_id || null;
    data.trips.forEach(trip => {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input type="checkbox" name="trip_ids" value="${trip.id}"></td>
            <td>${trip.passenger}</td>
            <td>${trip.origin}</td>
            <td>${trip.destination}</td>
            <td>${trip.type}</td>
        `;
        tripBody.appendChild(tr);
    });
});


// 2. پذیرش درخواست‌ها (مثل قبل)
acceptBtn.addEventListener('click', async () => { /* ... کد این بخش بدون تغییر باقی می‌ماند ... */ });
acceptBtn.addEventListener('click', async () => {
    const checked = [...document.querySelectorAll('input[name="trip_ids"]:checked')].map(x => x.value);

    if (checked.length === 0) {
        acceptResult.textContent = 'هیچ درخواستی انتخاب نشده است.';
        return;
    }
    if (!driverId) {
        acceptResult.textContent = 'شناسه راننده یافت نشد.';
        return;
    }

    const formData = new URLSearchParams();
    formData.append('driver_id', driverId);
    checked.forEach(id => formData.append('trip_ids', id));

    const res = await fetch("{% url 'accept_requests' %}", { method: "POST", body: formData });
    const data = await res.json();

    if (res.ok) {
        acceptResult.textContent = 'درخواست‌ها با موفقیت پذیرفته شدند. در حال هدایت به صف...';
        setTimeout(() => {
            window.location.href = "{% url 'driver_queue_page' %}";
        }, 1500);
    } else {
        acceptResult.textContent = 'خطا در ثبت پذیرش: ' + (data.error || 'خطای نامشخص');
    }
});


// ✅ 3. نمایش تمام سفرهای فعال (کد جدید)
showAllActiveTripsBtn.addEventListener('click', async () => {
    allActiveTripsBody.innerHTML = '<tr><td colspan="6">در حال بارگذاری...</td></tr>';
    allActiveTripsSection.style.display = 'block';

    try {
        const res = await fetch("{% url 'get_all_active_trips_api' %}");
        const data = await res.json();

        allActiveTripsBody.innerHTML = ''; // پاک کردن محتوای قبلی

        if (data.trips.length === 0) {
            allActiveTripsBody.innerHTML = '<tr><td colspan="6" style="text-align:center; color:gray;">هیچ سفر فعالی یافت نشد.</td></tr>';
            return;
        }

        data.trips.forEach(trip => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-trip-id', trip.id); // برای عملیات حذف و پایان
            tr.innerHTML = `
                <td>${trip.created_at}</td>
                <td>${trip.zone}</td>
                <td>${trip.request_type}</td>
                <td>${trip.passenger}</td>
                <td>${trip.driver}</td>
                <td>
                    <button class="btn btn-success btn-sm end-trip" data-id="${trip.id}">پایان سفر</button>
                    <button class="btn btn-danger btn-sm delete-trip" data-id="${trip.id}">حذف</button>
                </td>
            `;
            allActiveTripsBody.appendChild(tr);
        });
    } catch (error) {
        allActiveTripsBody.innerHTML = '<tr><td colspan="6" style="color:red;">خطا در دریافت اطلاعات.</td></tr>';
        console.error("Error fetching active trips:", error);
    }
});

// ✅ 4. مدیریت رویدادهای کلیک برای حذف و پایان سفر (به روش Event Delegation)
// این روش تضمین می‌کند که دکمه‌های جدیدی که با جاوااسکریپت ساخته می‌شوند هم کار کنند.
document.addEventListener('click', async (event) => {
    const target = event.target;
    
    // --- مدیریت پایان سفر ---
    if (target.matches('.end-trip')) {
        const tripId = target.dataset.id;
        if (!confirm('آیا از پایان این سفر مطمئن هستید؟')) return;

        const res = await fetch(`/ride/finish_trip/${tripId}/`, { method: 'POST' });
        const data = await res.json();

        if (res.ok && data.success) {
            target.closest('tr, table[data-trip-id]').remove(); // ردیف یا جدول مربوطه را حذف کن
        } else {
            alert(data.error || 'خطا در پایان سفر');
        }
    }

    // --- مدیریت حذف سفر ---
    if (target.matches('.delete-trip')) {
        const tripId = target.dataset.id;
        if (!confirm('آیا از حذف این سفر مطمئن هستید؟')) return;

        const response = await fetch(`/ride/delete_trip/${tripId}/`, { method: 'POST' });
        if (response.ok) {
            target.closest('tr, table[data-trip-id]').remove(); // ردیف یا جدول مربوطه را حذف کن
        } else {
            alert('خطا در حذف سفر.');
        }
    }
});

</script>

{% endblock %}
