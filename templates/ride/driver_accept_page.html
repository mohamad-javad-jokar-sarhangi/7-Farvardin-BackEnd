{% extends 'base.html' %}
{% load static %}
{% load tz %}

{% block title %}پذیرش درخواست‌ها و مدیریت سفر{% endblock %}

{% block content %}

<h2>پذیرش درخواست‌ها توسط راننده</h2>

<!-- بخش بررسی راننده و صف -->
<div class="form-group">
    <label for="driverName">نام راننده:</label>
    <input type="text" id="driverName" placeholder="مثلاً علی رضایی" class="form-control" style="display: inline-block; width: auto;">
    <button class="btn btn-primary" id="checkAccessBtn">بررسی دسترسی</button>
    <div id="accessError" class="error-message" style="margin-top: 10px;"></div>
</div>

<!-- دکمه جدید برای نمایش تمام سفرهای فعال -->
<div class="form-group" style="margin-top: 20px; border-top: 1px solid #ccc; padding-top: 20px;">
    <button class="btn btn-info" id="showAllActiveTripsBtn">نمایش تمام سفرهای فعال</button>
</div>


<!-- بخش نمایش درخواست‌های فعال (برای پذیرش) -->
<div id="requestsSection" style="display:none; margin-top: 20px;">
    <h3>درخواست‌های فعال قابل پذیرش</h3>
    <table class="table table-bordered table-striped" style="width:100%; text-align:center;">
        <thead>
            <tr>
                <th>انتخاب</th>
                <th>مسافر</th>
                <th>مبدأ</th>
                <th>مقصد</th>
                <th>نوع درخواست</th>
            </tr>
        </thead>
        <tbody id="tripBody"></tbody>
    </table>
    <button class="btn btn-success" id="acceptBtn" style="margin-top:15px;">✅ قبول درخواست‌ها</button>
    <div id="acceptResult" class="success-box" style="margin-top: 10px;"></div>
</div>


<!-- بخش جدید برای نمایش تمام سفرهای فعال (که با دکمه پر می‌شود) -->
<div id="allActiveTripsSection" style="display:none; margin-top:30px;">
    <h3>تمام سفرهای در حال انجام</h3>
    <table class="table table-bordered table-striped">
        <thead>
            <tr>
                <th>زمان ثبت</th>
                <th>منطقه</th>
                <th>نوع درخواست</th>
                <th>مسافر</th>
                <th>راننده</th>
                <th>عملیات</th>
            </tr>
        </thead>
        <tbody id="allActiveTripsBody"></tbody>
    </table>
</div>


<!-- ✅✅✅ بخش اصلاح‌شده برای نمایش سفرهای پذیرفته‌شده راننده ✅✅✅ -->
<h3 style="margin-top:40px;">سفرهای پذیرفته‌شده (مربوط به راننده جستجو شده)</h3>
<table class="table table-bordered table-striped">
    <thead>
        <tr>
            <th>زمان ثبت</th>
            <th>منطقه</th>
            <th>نوع درخواست</th>
            <th>مسافر</th>
            <th>راننده</th>
            <th>عملیات</th>
        </tr>
    </thead>
    <tbody>
        {% for trip in movements %}
        <tr data-trip-id="{{ trip.id }}">
            <td>{{ trip.created_at|localtime }}</td>
            <td>{{ trip.zone }}</td>
            <td>{{ trip.request_type }}</td>
            <td>{{ trip.passenger.username }}</td>
            <td>{{ trip.driver.username }}</td>
            <td>
                {% if not trip.is_finished %}
                    <button class="btn btn-success btn-sm end-trip" data-id="{{ trip.id }}">پایان سفر</button>
                {% endif %}
                <button class="btn btn-danger btn-sm delete-trip" data-id="{{ trip.id }}">حذف</button>
            </td>
        </tr>
        {% empty %}
        {# این قسمت زمانی اجرا می‌شود که movements خالی باشد #}
        <tr>
            <td colspan="6" class="text-center" style="color:gray;">برای راننده مشخصی سفری یافت نشد.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<!-- پایان بخش اصلاح‌شده -->


<script>
// === عناصر DOM ===
const driverInput = document.getElementById('driverName');
const checkBtn = document.getElementById('checkAccessBtn');
const tripBody = document.getElementById('tripBody');
const requestsSection = document.getElementById('requestsSection');
const accessError = document.getElementById('accessError');
const acceptBtn = document.getElementById('acceptBtn');
const acceptResult = document.getElementById('acceptResult');

// عناصر جدید
const showAllActiveTripsBtn = document.getElementById('showAllActiveTripsBtn');
const allActiveTripsSection = document.getElementById('allActiveTripsSection');
const allActiveTripsBody = document.getElementById('allActiveTripsBody');
let driverId = null;

// === رویدادها (Event Listeners) ===

// 1. بررسی دسترسی راننده
checkBtn.addEventListener('click', async () => {
    accessError.textContent = '';
    tripBody.innerHTML = '';
    requestsSection.style.display = 'none';
    acceptResult.textContent = '';
    driverId = null;

    const driverName = driverInput.value.trim();
    if (!driverName) {
        accessError.textContent = 'نام راننده را وارد کنید.';
        return;
    }

    try {
        const res = await fetch("{% url 'check_driver_access' %}", {
            method: "POST",
            headers: {"Content-Type": "application/x-www-form-urlencoded", "X-CSRFToken": "{{ csrf_token }}"},
            body: new URLSearchParams({ driver_name: driverName })
        });

        const data = await res.json();
        if (data.error) {
            accessError.textContent = data.error;
            return;
        }

        requestsSection.style.display = "block";
        driverId = data.driver_id || null;
        data.trips.forEach(trip => {
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="checkbox" name="trip_ids" value="${trip.id}"></td>
                <td>${trip.passenger}</td>
                <td>${trip.origin}</td>
                <td>${trip.destination}</td>
                <td>${trip.type}</td>
            `;
            tripBody.appendChild(tr);
        });

    } catch (e) {
        accessError.textContent = 'خطا در ارتباط با سرور.';
    }
});


// 2. پذیرش درخواست‌ها
acceptBtn.addEventListener('click', async () => {
    const checked = [...document.querySelectorAll('input[name="trip_ids"]:checked')].map(x => x.value);

    if (checked.length === 0) {
        acceptResult.textContent = 'هیچ درخواستی انتخاب نشده است.';
        return;
    }
    if (!driverId) {
        acceptResult.textContent = 'شناسه راننده یافت نشد.';
        return;
    }

    const formData = new URLSearchParams();
    formData.append('driver_id', driverId);
    checked.forEach(id => formData.append('trip_ids', id));
    
    try {
        const res = await fetch("{% url 'accept_requests' %}", {
            method: "POST",
            headers: {"X-CSRFToken": "{{ csrf_token }}"},
            body: formData
        });
        const data = await res.json();

        if (res.ok) {
            acceptResult.style.color = 'green';
            acceptResult.textContent = 'درخواست‌ها با موفقیت پذیرفته شدند. در حال هدایت به صف...';
            setTimeout(() => {
                window.location.href = "{% url 'driver_queue_page' %}";
            }, 1500);
        } else {
            acceptResult.style.color = 'red';
            acceptResult.textContent = 'خطا در ثبت پذیرش: ' + (data.error || 'خطای نامشخص');
        }
    } catch(e) {
        acceptResult.style.color = 'red';
        acceptResult.textContent = 'خطا در ارتباط با سرور.';
    }
});


// 3. نمایش تمام سفرهای فعال
showAllActiveTripsBtn.addEventListener('click', async () => {
    allActiveTripsBody.innerHTML = '<tr><td colspan="6" class="text-center">در حال بارگذاری...</td></tr>';
    allActiveTripsSection.style.display = 'block';

    try {
        const res = await fetch("{% url 'get_all_active_trips_api' %}");
        const data = await res.json();

        allActiveTripsBody.innerHTML = ''; // پاک کردن محتوای قبلی

        if (data.trips.length === 0) {
            allActiveTripsBody.innerHTML = '<tr><td colspan="6" class="text-center" style="color:gray;">هیچ سفر فعالی یافت نشد.</td></tr>';
            return;
        }

        data.trips.forEach(trip => {
            const tr = document.createElement('tr');
            tr.setAttribute('data-trip-id', trip.id);
            tr.innerHTML = `
                <td>${trip.created_at}</td>
                <td>${trip.zone}</td>
                <td>${trip.request_type}</td>
                <td>${trip.passenger}</td>
                <td>${trip.driver}</td>
                <td>
                    <button class="btn btn-success btn-sm end-trip" data-id="${trip.id}">پایان سفر</button>
                    <button class="btn btn-danger btn-sm delete-trip" data-id="${trip.id}">حذف</button>
                </td>
            `;
            allActiveTripsBody.appendChild(tr);
        });
    } catch (error) {
        allActiveTripsBody.innerHTML = '<tr><td colspan="6" class="text-center" style="color:red;">خطا در دریافت اطلاعات.</td></tr>';
        console.error("Error fetching active trips:", error);
    }
});

// 4. مدیریت رویدادهای کلیک برای حذف و پایان سفر (به روش Event Delegation)
document.addEventListener('click', async (event) => {
    const target = event.target;
    const tripId = target.dataset.id;
    if (!tripId) return;

    // --- مدیریت پایان سفر ---
    if (target.matches('.end-trip')) {
        if (!confirm('آیا از پایان این سفر مطمئن هستید؟')) return;

        const res = await fetch(`/ride/finish_trip/${tripId}/`, { 
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });
        
        if (res.ok) {
            const data = await res.json();
            if(data.success) {
                target.closest('tr[data-trip-id]').remove();
                alert('سفر با موفقیت به پایان رسید.');
            } else {
                 alert(data.error || 'خطا در پایان سفر');
            }
        } else {
            alert('خطای سرور در پایان سفر.');
        }
    }

    // --- مدیریت حذف سفر ---
    if (target.matches('.delete-trip')) {
        if (!confirm('آیا از حذف این سفر مطمئن هستید؟ این عمل غیرقابل بازگشت است.')) return;

        const response = await fetch(`/ride/delete_trip/${tripId}/`, {
            method: 'POST',
            headers: { 'X-CSRFToken': '{{ csrf_token }}' }
        });

        if (response.ok) {
            target.closest('tr[data-trip-id]').remove();
            alert('سفر با موفقیت حذف شد.');
        } else {
            alert('خطا در حذف سفر.');
        }
    }
});

</script>

{% endblock %}
