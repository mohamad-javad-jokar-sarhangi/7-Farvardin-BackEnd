{% extends "base.html" %}
{% block title %}Ø§ÛŒØ¬Ø§Ø¯ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¬Ø¯ÛŒØ¯{% endblock %}
{% block content %}
<h2>Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø³ÙØ± Ø¬Ø¯ÛŒØ¯</h2>

<form id="tripForm" method="POST" class="request-form">
    {% csrf_token %}

    <div class="form-group">
        <label for="passenger_search">Ù†Ø§Ù… Ù…Ø³Ø§ÙØ±:</label>
        <input type="text" id="passenger_search" placeholder="Ø¬Ø³ØªØ¬ÙˆÛŒ Ù†Ø§Ù… Ù…Ø³Ø§ÙØ±..." autocomplete="off">
        <input type="hidden" name="user_id" id="selected_user_id">
        <div id="suggestions"></div>

        <label>Ù…Ø¨Ø¯Ø£:</label>
        <input type="text" name="origin" required>

        <label>Ù…Ù‚ØµØ¯:</label>
        <input type="text" name="destination" required>

        <label>ØªØ§Ø±ÛŒØ®:</label>
        <input type="date" name="request_date" id="request_date">
        <label>Ø²Ù…Ø§Ù†:</label>
        <input type="time" name="request_time" id="request_time">

        <label>Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª:</label>
        <select name="request_type" id="request_type">
            <option value="normal">Normal</option>
            <option value="hurryup">Hurry Up</option>
            <option value="vip">VIP</option>
        </select>
    </div>

    <div id="errorBox" style="color:red; margin-top:10px;"></div>
    <button type="submit" class="button">Ø«Ø¨Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª</button>
</form>

<a href="{% url 'current_tripes' %}" class="button">Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ø¯Ø±Ø®ÙˆØ§Ø³Øªâ€ŒÙ‡Ø§ÛŒ ÙØ¹Ø§Ù„</a>

<script>
const form = document.getElementById("tripForm");
const errorBox = document.getElementById("errorBox");

// ğŸ•’ ØªÙ†Ø¸ÛŒÙ… Ø®ÙˆØ¯Ú©Ø§Ø± ØªØ§Ø±ÛŒØ® Ùˆ Ø²Ù…Ø§Ù† ÙØ¹Ù„ÛŒ
window.addEventListener("load", () => {
    const now = new Date();
    document.getElementById("request_date").value = now.toISOString().split("T")[0];
    document.getElementById("request_time").value = now.toTimeString().slice(0,5);
});

// ğŸ§  Ù‡Ù†Ø¯Ù„ÛŒÙ†Ú¯ Ø³Ø§Ø¬Ø³Øª
const input = document.getElementById("passenger_search");
const suggestionsBox = document.getElementById("suggestions");

input.addEventListener("input", async () => {
    const q = input.value.trim();
    if (q.length < 2) { suggestionsBox.innerHTML = ""; return; }
    const res = await fetch(`/ride/search-passengers/?q=${q}`);
    const data = await res.json();
    suggestionsBox.innerHTML = "";
    data.forEach(u => {
        const d = document.createElement("div");
        d.textContent = `${u.name} - ${u.phone}`;
        d.className = "suggest-item";
        d.onclick = () => {
            input.value = u.name;
            document.getElementById("selected_user_id").value = u.id;
            suggestionsBox.innerHTML = "";
        }
        suggestionsBox.appendChild(d);
    });
});

// âš™ï¸ Ù‡Ù†Ø¯Ù„ÛŒÙ†Ú¯ Ø§Ø±ÙˆØ± Ø§Ø² Ø¨Ú©â€ŒØ§Ù†Ø¯
form.addEventListener("submit", async (e) => {
    e.preventDefault();
    errorBox.textContent = "";
    const formData = new FormData(form);
    const res = await fetch("", { method: "POST", body: formData });
    const contentType = res.headers.get("Content-Type");

    // Ø§Ú¯Ø± Ø¨Ú©â€ŒØ§Ù†Ø¯ JsonResponse ÙØ±Ø³ØªØ§Ø¯
    if (contentType && contentType.includes("application/json")) {
        const data = await res.json();
        if (data.error) {
            errorBox.textContent = data.error;
            return;
        }
    }

    // Ø¯Ø± ØµÙˆØ±Øª Ù…ÙˆÙÙ‚ÛŒØª Redirect
    window.location.href = "{% url 'current_tripes' %}";
});
</script>
{% endblock %}
