{% extends 'base.html' %}

{% block title %}ğŸ§¾ Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ±Ù‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡{% endblock %}

{% block content %}

<h2 style="text-align:center; color:var(--accent);">ğŸ“Š Ú¯Ø²Ø§Ø±Ø´ Ø³ÙØ±Ù‡Ø§ÛŒ Ø§Ù†Ø¬Ø§Ù…â€ŒØ´Ø¯Ù‡</h2>

<form id="dateRangeForm" style="max-width:700px; margin:30px auto; text-align:center;">
    <div class="form-group">
        <label>Ø§Ø² ØªØ§Ø±ÛŒØ®:</label>
        <input type="datetime-local" id="startDate" name="startDate">
    </div>
    <div class="form-group">
        <label>ØªØ§ ØªØ§Ø±ÛŒØ®:</label>
        <input type="datetime-local" id="endDate" name="endDate">
    </div>
    <button type="submit" class="button">Ù†Ù…Ø§ÛŒØ´ Ø³ÙØ±Ù‡Ø§ Ø¯Ø± Ø¨Ø§Ø²Ù‡</button>
</form>

<hr style="border-color:var(--table-border); margin:30px auto; width:80%;">

<h3 id="tripSummary" style="text-align:center;">Ø¢Ø®Ø±ÛŒÙ† Û±Û° Ø³ÙØ± Ø«Ø¨Øªâ€ŒØ´Ø¯Ù‡</h3>

<table id="tripHistoryTable">
    <thead>
        <tr>
            <th>Ø±Ø§Ù†Ù†Ø¯Ù‡</th>
            <th>Ù…Ø³Ø§ÙØ±</th>
            <th>Ù…Ù†Ø·Ù‚Ù‡</th>
            <th>Ù†ÙˆØ¹ Ø¯Ø±Ø®ÙˆØ§Ø³Øª</th>
            <th>Ø²Ù…Ø§Ù† Ø´Ø±ÙˆØ¹</th>
            <th>Ø²Ù…Ø§Ù† Ù¾Ø§ÛŒØ§Ù†</th>
            <th>Ø¹Ù…Ù„ÛŒØ§Øª</th> <!-- âœ… Ø³ØªÙˆÙ† Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù -->
        </tr>
    </thead>
    <tbody id="tripHistoryBody"></tbody>
</table>

<script>
async function loadTrips(startDate = null, endDate = null) {
    // âœ… URL Ø±Ø§ Ø¨Ø±Ø§ÛŒ Ø¯Ø±ÛŒØ§ÙØª Ø¯Ø§Ø¯Ù‡â€ŒÙ‡Ø§ÛŒ ØªØ§Ø±ÛŒØ®Ú†Ù‡ Ø§ØµÙ„Ø§Ø­ Ù…ÛŒâ€ŒÚ©Ù†ÛŒÙ…
    let url = "{% url 'trip_history_api' %}"; 
    if (startDate && endDate) {
        url += `?start=${startDate}&end=${endDate}`;
    }

    try {
        const res = await fetch(url);
        const data = await res.json();

        const tbody = document.getElementById("tripHistoryBody");
        const summary = document.getElementById("tripSummary");
        tbody.innerHTML = ""; // Ù¾Ø§Ú© Ú©Ø±Ø¯Ù† Ø¬Ø¯ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ø² Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¯Ø§Ø¯Ù‡ Ø¬Ø¯ÛŒØ¯

        if (data.trips && data.trips.length > 0) {
            summary.textContent = `ØªØ¹Ø¯Ø§Ø¯ Ø³ÙØ±Ù‡Ø§: ${data.trips.length}`;
            data.trips.forEach(t => {
                // âœ… ÛŒÚ© Ø±Ø¯ÛŒÙ Ø¬Ø¯ÛŒØ¯ Ø¯Ø± Ø¬Ø¯ÙˆÙ„ Ø¨Ø§ Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ù…ÛŒâ€ŒØ³Ø§Ø²ÛŒÙ…
                const row = `
                    <tr>
                        <td>${t.driver}</td>
                        <td>${t.passenger}</td>
                        <td>${t.region}</td>
                        <td>${t.request_type}</td>
                        <td>${t.start_time}</td>
                        <td>${t.finish_time}</td>
                        <td>
                            <!-- Ø¯Ú©Ù…Ù‡ Ø­Ø°Ù Ø¨Ø§ data-id Ø¨Ø±Ø§ÛŒ Ù†Ú¯Ù‡Ø¯Ø§Ø±ÛŒ Ø´Ù†Ø§Ø³Ù‡ Ø³ÙØ± -->
                            <button class="button button-danger" data-id="${t.id}">Ø­Ø°Ù</button>
                        </td>
                    </tr>`;
                tbody.innerHTML += row;
            });
        } else {
            summary.textContent = "Ù‡ÛŒÚ† Ø³ÙØ±ÛŒ Ø¯Ø± Ø§ÛŒÙ† Ø¨Ø§Ø²Ù‡ ÛŒØ§ÙØª Ù†Ø´Ø¯.";
        }
    } catch (error) {
        console.error("Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø³ÙØ±Ù‡Ø§:", error);
        document.getElementById("tripSummary").textContent = "Ø®Ø·Ø§ Ø¯Ø± Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø³Ø±ÙˆØ±.";
    }
}

// âœ…âœ…âœ… Ù…Ù†Ø·Ù‚ Ø¬Ø¯ÛŒØ¯ Ø¨Ø±Ø§ÛŒ Ù…Ø¯ÛŒØ±ÛŒØª Ú©Ù„ÛŒÚ© Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø­Ø°Ù âœ…âœ…âœ…
document.getElementById('tripHistoryBody').addEventListener('click', async (event) => {
    // ÙÙ‚Ø· Ø§Ú¯Ø± Ø±ÙˆÛŒ Ø¯Ú©Ù…Ù‡â€ŒØ§ÛŒ Ø¨Ø§ Ú©Ù„Ø§Ø³ button-danger Ú©Ù„ÛŒÚ© Ø´Ø¯Ù‡ Ø¨ÙˆØ¯ØŒ Ø§Ø¯Ø§Ù…Ù‡ Ø¨Ø¯Ù‡
    if (event.target && event.target.classList.contains('button-danger')) {
        const tripId = event.target.dataset.id; // Ø´Ù†Ø§Ø³Ù‡ Ø³ÙØ± Ø±Ø§ Ø§Ø² Ø¯Ú©Ù…Ù‡ Ø¨Ø®ÙˆØ§Ù†
        
        // Ø§Ø² Ú©Ø§Ø±Ø¨Ø± ØªØ§ÛŒÛŒØ¯ Ø¨Ú¯ÛŒØ±
        if (confirm(`Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø³ÙØ± Ø¨Ø§ Ø´Ù†Ø§Ø³Ù‡ ${tripId} Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ`)) {
            try {
                const response = await fetch(`/ride/delete_trip_history/${tripId}/`, {
                    method: 'POST',
                });

                if (response.ok) {
                    // Ø§Ú¯Ø± Ø­Ø°Ù Ù…ÙˆÙÙ‚ Ø¨ÙˆØ¯ØŒ Ø±Ø¯ÛŒÙ Ø±Ø§ Ø§Ø² Ø¬Ø¯ÙˆÙ„ Ù¾Ø§Ú© Ú©Ù†
                    const rowToDelete = event.target.closest('tr');
                    rowToDelete.remove();
                    alert('Ø³ÙØ± Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø­Ø°Ù Ø´Ø¯.');
                } else {
                    // Ø§Ú¯Ø± Ø³Ø±ÙˆØ± Ø®Ø·Ø§ Ø¯Ø§Ø¯
                    const errorData = await response.json();
                    alert(`Ø®Ø·Ø§ Ø¯Ø± Ø­Ø°Ù: ${errorData.message}`);
                }
            } catch (error) {
                console.error("Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡:", error);
                alert('Ø®Ø·Ø§ÛŒ Ø§Ø±ØªØ¨Ø§Ø·ÛŒ Ø¯Ø± Ù‡Ù†Ú¯Ø§Ù… Ø­Ø°Ù Ø³ÙØ±.');
            }
        }
    }
});


// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø§ÙˆÙ„ÛŒÙ‡ (Ø¢Ø®Ø±ÛŒÙ† Û±Û° Ø³ÙØ±)
window.addEventListener('load', () => loadTrips());

// ÙÛŒÙ„ØªØ± Ø¨Ø§Ø²Ù‡ Ø²Ù…Ø§Ù†ÛŒ
document.getElementById('dateRangeForm').addEventListener('submit', e => {
    e.preventDefault();
    const start = document.getElementById('startDate').value;
    const end = document.getElementById('endDate').value;
    if (!start || !end) {
        alert('Ù„Ø·ÙØ§Ù‹ Ù‡Ø± Ø¯Ùˆ ØªØ§Ø±ÛŒØ® Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.');
        return;
    }
    loadTrips(start, end);
});
</script>

{% endblock %}
